<!DOCTYPE html>
<html lang='zh-Hant'>
  <head>
    <meta charset='utf-8'>
    <title>Garbage Collector - Crystal 程式語言 
    </title>
    <!-- Import Google Icon Font -->
    <link href='https://fonts.googleapis.com/icon?family=Material+Icons|Roboto+Mono' rel='stylesheet'>
    <link type="text/css" rel="stylesheet" href="/assets/stylesheet.css">
    <link href='/feed.xml' rel='alternate' title='Atom 1.0' type='application/atom+xml'>
    <link href='/favicon.png' rel='icon' type='image/png'>
    <link href='/favicon.ico' rel='shortcut icon' type='image/x-icon'>
    <!-- Begin Jekyll SEO tag v1.4.0 -->
<title>Garbage Collector - Crystal 程式語言</title>
<meta property="og:title" content="Garbage Collector" />
<meta name="description" content="Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the Boehm-Demers-Weiser conservative garbage collector into the language." />
<meta property="og:description" content="Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the Boehm-Demers-Weiser conservative garbage collector into the language." />
<link rel="canonical" href="http://crystal-tw.github.io/2013/12/05/garbage-collector.html" />
<meta property="og:url" content="http://crystal-tw.github.io/2013/12/05/garbage-collector.html" />
<meta property="og:site_name" content="Crystal 程式語言" />
<meta property="og:image" content="http://crystal-tw.github.io/images/icon.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2013-12-05T00:00:00+00:00" />
<link rel="next" href="http://crystal-tw.github.io/2014/04/27/type-inference-rules.html" title="Type inference rules" />
<link rel="prev" href="http://crystal-tw.github.io/2013/11/14/good-bye-ruby-thursday.html" title="Good bye Ruby Thursday" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@CrystalLanguage" />
<meta name="twitter:creator" content="@waj" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Garbage Collector",
    "image": "http://crystal-tw.github.io/images/icon.png",
    "datePublished": "2013-12-05T00:00:00+00:00",
    "description": "Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the Boehm-Demers-Weiser conservative garbage collector into the language.",
    "logo": "http://crystal-tw.github.io/images/crystal-h.png",
    "url": "http://crystal-tw.github.io/2013/12/05/garbage-collector.html"
  }
</script>
<!-- End Jekyll SEO tag -->
    <!-- Let browser know website is optimized for mobile -->
    <meta content='width=device-width, initial-scale=1.0' name='viewport'>
    <script src='https://code.jquery.com/jquery-3.1.1.min.js' type='text/javascript'></script>
  </head>
  <body>
    <div class="wrapper ">
      <nav role='navigation'>
  <div class='nav-wrapper no-select'>
    
      <a class='brand-logo' id='logo-container'>
        <canvas height='120' id='logo-canvas' style='cursor:move' width='120'></canvas>
      </a>
    
    <ul class='right hide-on-med-and-down' id='nav-desktop'>
      

  

  
    <li>
      <a href="/" >
        
          Home
        
      </a>
    </li>
  

  
    <li>
      <a href="/blog/" >
        
          Blog
        
      </a>
    </li>
  

  
    <li>
      <a href="/sponsors/" >
        
          Sponsors
        
      </a>
    </li>
  

  
    <li>
      <a href="/community/" >
        
          Community
        
      </a>
    </li>
  

  
    <li>
      <a href="/media/" >
        
          Media
        
      </a>
    </li>
  

<li>
  <a href='http://tw.crystal-lang.org/docs/' target="_blank">入門文件</a>
</li>
<li>
  <a href='https://crystal-lang.org/api/' target="_blank">API</a>
</li>
<li>
  <a href='https://github.com/crystal-lang/crystal' target="_blank">GitHub</a>
</li>


    </ul>
    <ul class='side-nav' id='nav-mobile'>
      

  

  
    <li>
      <a href="/" >
        
          Home
        
      </a>
    </li>
  

  
    <li>
      <a href="/blog/" >
        
          Blog
        
      </a>
    </li>
  

  
    <li>
      <a href="/sponsors/" >
        
          Sponsors
        
      </a>
    </li>
  

  
    <li>
      <a href="/community/" >
        
          Community
        
      </a>
    </li>
  

  
    <li>
      <a href="/media/" >
        
          Media
        
      </a>
    </li>
  

<li>
  <a href='http://tw.crystal-lang.org/docs/' target="_blank">入門文件</a>
</li>
<li>
  <a href='https://crystal-lang.org/api/' target="_blank">API</a>
</li>
<li>
  <a href='https://github.com/crystal-lang/crystal' target="_blank">GitHub</a>
</li>


    </ul>
    <a class='button-collapse' data-activates='nav-mobile' href='#'>
      <i class='material-icons'>menu</i>
    </a>
  </div>
</nav>

      
        <div class='post-header'>
  <div class="container">
    <div class='valign row'>
      <div class="col m2"></div>
      <div class="col s12 m9">
        <div class="author small">
          
          
            <img src="/assets/authors/waj.jpg" width="360" height="360" alt="authors/waj.jpg">
          
          
            <span class="author_name">Juan Wajnerman</span>
          
          
          
            <span class="date">05 Dec 2013</span>
          
        </div>

        <h1 class='title'>Garbage Collector</h1>
      </div>
      <div class="col m1"></div>
    </div>
  </div>
</div>

      
      <main>
        <div class="container">
  <div class="row post-layout">
    <div class="col m2 share">
      <p class="title small share-title">Share</p>
      <div class="share-list">
        
        <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2F127.0.0.1%2F2013%2F12%2F05%2Fgarbage-collector.html&text=Garbage+Collector&via=CrystalLanguage" target="_blank">
          <div class="share-item"><i class="extra-icons twitter gray"></i></div>
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2F127.0.0.1%2F2013%2F12%2F05%2Fgarbage-collector.html" target="_blank">
          <div class="share-item"><i class="extra-icons facebook gray"></i></div>
        </a>
        <a href="https://plus.google.com/share?url=https%3A%2F%2F127.0.0.1%2F2013%2F12%2F05%2Fgarbage-collector.html" target="_blank">
          <div class="share-item"><i class="extra-icons google_plus gray"></i></div>
          </a>
      </div>
    </div>

    <div class="col s12 m9">
      <p>Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the <a href="http://www.hpl.hp.com/personal/Hans_Boehm/gc/">Boehm-Demers-Weiser conservative garbage collector</a> into the language.</p>

<p>Although we plan to implement a more appropriate and custom garbage collector in the future, it’s a really good starting point to make the language more robust and usable.</p>

<p>In order to make this collector work with Crystal we had to make sure all the allocated block pointers were properly <a href="https://github.com/crystal-lang/crystal/commit/6657d3c84c93ec0c886aa9262b2a33791e22285f">aligned in memory</a>. Unions and type hierarchies were using packed structs and that made some pointers “invisible” to the GC and thus many blocks still in use were being deallocated and consecuently making everything crash quite easily.</p>

<p>Some quick tests reflect the obvious benefits of freeing some memory. For example, <code class="highlighter-rouge">samples/mandelbrot2.cr</code> used to require around 13MB of memory to run. Once the GC is enabled it uses just under 1MB.</p>

<p>There is still a long path to travel, but now with a working memory manager we might consider start <a href="http://en.wikipedia.org/wiki/Eating_your_own_dog_food">dogfooding</a> Crystal for some non production or critical tools in our everyday work.</p>

    </div>
    <div class="col m1"></div>
  </div>

  <div class="row disqus">
    <div class="col m2"></div>
    <div class="col s12 m9" id='disqus_thread'>
      <p>Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the <a href="http://www.hpl.hp.com/personal/Hans_Boehm/gc/">Boehm-Demers-Weiser conservative garbage collector</a> into the language.</p>

<p>Although we plan to implement a more appropriate and custom garbage collector in the future, it’s a really good starting point to make the language more robust and usable.</p>

<p>In order to make this collector work with Crystal we had to make sure all the allocated block pointers were properly <a href="https://github.com/crystal-lang/crystal/commit/6657d3c84c93ec0c886aa9262b2a33791e22285f">aligned in memory</a>. Unions and type hierarchies were using packed structs and that made some pointers “invisible” to the GC and thus many blocks still in use were being deallocated and consecuently making everything crash quite easily.</p>

<p>Some quick tests reflect the obvious benefits of freeing some memory. For example, <code class="highlighter-rouge">samples/mandelbrot2.cr</code> used to require around 13MB of memory to run. Once the GC is enabled it uses just under 1MB.</p>

<p>There is still a long path to travel, but now with a working memory manager we might consider start <a href="http://en.wikipedia.org/wiki/Eating_your_own_dog_food">dogfooding</a> Crystal for some non production or critical tools in our everyday work.</p>

    </div>
    <div class="col m1"></div>
  </div>
</div>
<script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'crystal-lang'; // required: replace example with your forum shortname
  var disqus_identifier = '/2013/12/05/garbage-collector';
  var disqus_title = "Garbage Collector";
  var disqus_url = "http://crystal-lang.org//2013/12/05/garbage-collector.html";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>
  Please enable JavaScript to view the
  <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
</noscript>
<a class='dsq-brlink' href='http://disqus.com'>
  comments powered by
  <span class='logo-disqus'>Disqus</span>
</a>

      </main>
      <footer>
  <div class="row">
    <div class="col s12 m12 l6 crystal" style="margin-top: -.5em;">
      Crystal is licensed under the Apache License,
      <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>
        Version 2.0
      </a>
			<br />
			本站正體中文（臺灣）翻譯由 
			<a href='https://github.com/crystal-tw' target='_blank'>
				Crystal-TW
			</a>
			社群貢獻。
    </div>
    <div class="col s12 m12 l6 manas right-align black-text">
      Crystal language, born &amp; raised at
      <a href="https://manas.tech" target="_blank" class="black-text">Manas</a>
      <a href="https://manas.tech" target="_blank" class="logo">
        <i class="manas"></i>
      </a>
    </div>
  </div>
</footer>

    </div>

    <script id="dsq-count-scr" src="//crystal-lang.disqus.com/count.js" async></script>
    <script type="text/javascript" src="/assets/bundle.js"></script>
    <!-- Disable original GA temporary
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42353458-1', 'auto');
  ga('send', 'pageview');
</script>
-->

  </body>
</html>
